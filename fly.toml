app = 'usvisachat'  # Your existing Fly.io app
primary_region = 'iad'  # IAD (Ashburn, VA) - current region

[build]
  dockerfile = 'Dockerfile.fullstack'

[deploy]
  strategy = 'immediate'

[env]
  PORT = '8000'
  PYTHONUNBUFFERED = '1'
  ENVIRONMENT = 'production'
  
  # MongoDB Configuration (use Fly secrets for credentials)
  MONGODB_DATABASE = 'visa_community'
  MONGODB_TLS_ENABLED = 'false'  # Fly.io handles TLS
  MONGODB_AUTH_MECHANISM = 'MONGODB-X509'
  
  # LLM Configuration - use Groq for production
  LLM_PROVIDER = 'groq'
  LLM_MODEL = 'llama-3.1-8b-instant'
  
  # Email Configuration
  EMAIL_MODE = 'mock'
  
  # Qdrant Configuration - using Fly.io app
  QDRANT_HOST = 'qdrant.internal'  # Internal Fly.io DNS
  QDRANT_PORT = '6333'
  
  # CORS Configuration
  ALLOWED_ORIGINS = 'https://usvisachat.fly.dev'  # Your actual domain

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = 'suspend'  # Suspend when idle to save costs
  auto_start_machines = true
  min_machines_running = 0  # Allow scaling to zero
  processes = ['app']

  # Health checks
  [[http_service.checks]]
    grace_period = '60s'  # Give app time to load numpy/torch
    interval = '30s'
    method = 'GET'
    path = '/health'
    timeout = '10s'
    type = 'http'

[[vm]]
  memory = '2gb'  # Increased for numpy/torch dependencies
  cpu_kind = 'shared'
  cpus = 1

# Note: Data storage handled by external services (MongoDB Atlas, Qdrant)
# No persistent volumes needed for stateless web app
